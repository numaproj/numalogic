apiVersion: numaflow.numaproj.io/v1alpha1
kind: Pipeline
metadata:
  name: aiops-rollouts-pl
spec:
  edges:
    - from: input
      to: window
    - from: window
      to: preprocess
    - from: preprocess
      to: inference
      conditions:
        tags:
          operator: or
          values:
            - inference
    - from: preprocess
      to: staticthresh
      conditions:
        tags:
          operator: or
          values:
            - staticthresh
    - from: preprocess
      to: trainer
      conditions:
        tags:
          operator: or
          values:
            - train
    - from: inference
      to: postprocess
      conditions:
        tags:
          operator: or
          values:
            - postprocess
    - from: inference
      to: trainer
      conditions:
        tags:
          operator: or
          values:
            - train
    - from: inference
      to: staticthresh
      conditions:
        tags:
          operator: or
          values:
            - staticthresh
    - from: postprocess
      to: prom-pusher
      conditions:
        tags:
          operator: or
          values:
            - output
    - from: postprocess
      to: trainer
      conditions:
        tags:
          operator: or
          values:
            - train
      onFull: discardLatest
    - from: postprocess
      to: staticthresh
      conditions:
        tags:
          operator: or
          values:
            - staticthresh
    - from: staticthresh
      to: prom-pusher
    - from: trainer
      to: trainer-out
  interStepBufferServiceName: numalogic-isbs
  vertices:
    - name: input
      scale:
        max: 1
        min: 1
      containerTemplate:
        resources:
          limits:
            cpu: 512m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 256Mi
      source:
        http:
          service: false
        transformer:
          container:
            args:
              - namespace
              - app
            env:
              - name: DEBUG
                value: "true"
              - name: NUM_CPU_MULTIPROC
                value: "2"
              - name: MAX_THREADS
                value: "3"
              - name: LABELS_TO_INCLUDE
                value: namespace,app,assetId,intuit_alert
            image: docker.intuit.com/oss-analytics/numalogic-udfs/service/srctx:master-30d7992
            resources:
              limits:
                cpu: 512m
                memory: 512Mi
              requests:
                cpu: 50m
                memory: 256Mi
    - limits:
        readBatchSize: 200
      name: window
      scale:
        max: 1
        min: 1
      containerTemplate:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
      udf:
        container:
          env:
            - name: DEBUG
              value: "true"
            - name: BASE_CONF_PATH
              value: /app/config/default-configs/config.yaml
            - name: METRICS_CONF_PATH
              value: /app/config/default-configs/metrics.yaml
          image: docker.intuit.com/oss-analytics/numalogic-udfs/service/reducer:master-30d7992
          resources:
            limits:
              cpu: 500m
              memory: 2Gi
            requests:
              cpu: 50m
              memory: 1Gi
          imagePullPolicy: Always
          volumeMounts:
            - mountPath: /app/config/app-configs
              name: app-configs
            - mountPath: /app/config/default-configs
              name: default-configs
        groupBy:
          keyed: true
          storage:
            persistentVolumeClaim:
              accessMode: ReadWriteOnce
              volumeSize: 5Gi
          window:
            sliding:
              length: 7m0s
              slide: 30s
      volumes:
        - configMap:
            name: numalogic-rollouts-default-mv-configs
          name: default-configs
        - configMap:
            name: numalogic-rollouts-app-mv-configs
          name: app-configs
    - limits:
        readBatchSize: 200
      name: preprocess
      scale:
        max: 1
        min: 1
      containerTemplate:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
      udf:
        container:
          args:
            - python
            - -m
            - numalogic.udfs
            - preprocess
          env:
            - name: DEBUG
              value: "true"
            - name: BASE_CONF_PATH
              value: /app/config/default-configs/config.yaml
            - name: METRICS_CONF_PATH
              value: /app/config/default-configs/metrics.yaml
            - name: REDIS_AUTH
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: isbsvc-redis-isbs-redis-auth
          image: docker.intuit.com/quay-rmt/numaio/numalogic/udf:v0.11.0
          imagePullPolicy: Always
          resources:
            limits:
              cpu: 500m
              memory: 2Gi
            requests:
              cpu: 70m
              memory: 512Mi
          volumeMounts:
            - mountPath: /app/config/app-configs
              name: app-configs
            - mountPath: /app/config/default-configs
              name: default-configs
      volumes:
        - configMap:
            name: numalogic-rollouts-app-mv-configs
          name: app-configs
        - configMap:
            name: numalogic-rollouts-default-mv-configs
          name: default-configs
    - limits:
        readBatchSize: 100
      name: inference
      scale:
        max: 1
        min: 1
      containerTemplate:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
      udf:
        container:
          args:
            - python
            - -m
            - numalogic.udfs
            - inference
            - multiproc
          env:
            - name: NUM_CPU_MULTIPROC
              value: "4"
            - name: DEBUG
              value: "true"
            - name: BASE_CONF_PATH
              value: /app/config/default-configs/config.yaml
            - name: METRICS_CONF_PATH
              value: /app/config/default-configs/metrics.yaml
            - name: REDIS_AUTH
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: isbsvc-redis-isbs-redis-auth
          image: docker.intuit.com/quay-rmt/numaio/numalogic/udf:v0.11.0
          imagePullPolicy: Always
          resources:
            limits:
              cpu: 500m
              memory: 2Gi
            requests:
              cpu: 70m
              memory: 512Mi
          volumeMounts:
            - mountPath: /app/config/app-configs
              name: app-configs
            - mountPath: /app/config/default-configs
              name: default-configs
      volumes:
        - configMap:
            name: numalogic-rollouts-app-mv-configs
          name: app-configs
        - configMap:
            name: numalogic-rollouts-default-mv-configs
          name: default-configs
    - limits:
        readBatchSize: 200
      name: postprocess
      scale:
        max: 1
        min: 1
      containerTemplate:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
      udf:
        container:
          args:
            - python
            - -m
            - numalogic.udfs
            - postprocess
          env:
            - name: SCORE_PREFIX
              value: namespace_app_rollouts_unified
            - name: DEBUG
              value: "true"
            - name: BASE_CONF_PATH
              value: /app/config/default-configs/config.yaml
            - name: METRICS_CONF_PATH
              value: /app/config/default-configs/metrics.yaml
            - name: REDIS_AUTH
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: isbsvc-redis-isbs-redis-auth
          image: docker.intuit.com/quay-rmt/numaio/numalogic/udf:v0.11.0
          imagePullPolicy: Always
          resources:
            limits:
              cpu: 500m
              memory: 2Gi
            requests:
              cpu: 70m
              memory: 512Mi
          volumeMounts:
            - mountPath: /app/config/app-configs
              name: app-configs
            - mountPath: /app/config/default-configs
              name: default-configs
      volumes:
        - configMap:
            name: numalogic-rollouts-app-mv-configs
          name: app-configs
        - configMap:
            name: numalogic-rollouts-default-mv-configs
          name: default-configs
    - limits:
        readBatchSize: 200
      name: staticthresh
      scale:
        max: 1
        min: 1
      containerTemplate:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
      udf:
        container:
          args:
            - python
            - -m
            - numalogic.udfs
            - staticthresh
          env:
            - name: SCORE_PREFIX
              value: namespace_app_rollouts_unified
            - name: DEBUG
              value: "true"
            - name: BASE_CONF_PATH
              value: /app/config/default-configs/config.yaml
            - name: METRICS_CONF_PATH
              value: /app/config/default-configs/metrics.yaml
            - name: REDIS_AUTH
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: isbsvc-redis-isbs-redis-auth
          image: docker.intuit.com/quay-rmt/numaio/numalogic/udf:v0.11.0
          imagePullPolicy: Always
          resources:
            limits:
              cpu: 500m
              memory: 1Gi
            requests:
              cpu: 50m
              memory: 512Mi
          volumeMounts:
            - mountPath: /app/config/app-configs
              name: app-configs
            - mountPath: /app/config/default-configs
              name: default-configs
      volumes:
        - configMap:
            name: numalogic-rollouts-app-mv-configs
          name: app-configs
        - configMap:
            name: numalogic-rollouts-default-mv-configs
          name: default-configs
    - limits:
        readBatchSize: 1
      name: trainer
      scale:
        max: 3
        min: 1
      containerTemplate:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
      udf:
        container:
          args:
            - python
            - -m
            - numalogic.udfs
            - promtrainer
            - multiproc
          env:
            - name: DEBUG
              value: "true"
            - name: BASE_CONF_PATH
              value: /app/config/default-configs/config.yaml
            - name: METRICS_CONF_PATH
              value: /app/config/default-configs/metrics.yaml
            - name: NUM_CPU_MULTIPROC
              value: "4"
            - name: REDIS_AUTH
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: isbsvc-redis-isbs-redis-auth
          image: docker.intuit.com/quay-rmt/numaio/numalogic/udf:v0.11.0
          imagePullPolicy: Always
          resources:
            limits:
              cpu: "1"
              memory: 4Gi
            requests:
              cpu: 100m
              memory: 2Gi
          volumeMounts:
            - mountPath: /app/config/app-configs
              name: app-configs
            - mountPath: /app/config/default-configs
              name: default-configs
      volumes:
        - configMap:
            name: numalogic-rollouts-app-mv-configs
          name: app-configs
        - configMap:
            name: numalogic-rollouts-default-mv-configs
          name: default-configs
    - name: trainer-out
      sink:
        blackhole: {}
      containerTemplate:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
    - name: prom-pusher
      scale:
        max: 5
        min: 1
      containerTemplate:
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
      sink:
        udsink:
          container:
            args:
              - ./main
              - --enableMsgTransformer
              - "true"
            env:
              - name: SKIP_VALIDATION_FAILED
                value: "true"
              - name: PROMETHEUS_SERVER
                value: http://prometheus-pushgateway.addon-metricset-ns.svc:9091
              - name: METRICS_NAME
                value: namespace_app_rollouts_unified_anomaly
            image: docker.intuit.com/quay-rmt/numaio/numaflow-sink/prometheus-pusher:v0.1.5
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 50m
                memory: 256Mi